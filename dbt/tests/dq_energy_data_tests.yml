version: 2

models:
  - name: stg_energy_data
    description: "Staging модель для энергетических данных с DQ проверками"
    
    columns:
      - name: id
        description: "Уникальный идентификатор измерения"
        tests:
          - not_null
          - unique
          
      - name: timestamp
        description: "Временная метка измерения"
        tests:
          - not_null
          - dbt_utils.is_timestamp
          
      - name: energy_consumption
        description: "Потребление энергии в кВт*ч"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 10000
          - dbt_utils.not_constant
          
      - name: voltage
        description: "Напряжение в В"
        tests:
          - dbt_utils.accepted_range:
              min_value: 200
              max_value: 250
          - dbt_utils.not_constant
          
      - name: current
        description: "Ток в А"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
          - dbt_utils.not_constant
          
      - name: power_factor
        description: "Коэффициент мощности"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0.8
              max_value: 1.0
          - dbt_utils.not_constant
          
      - name: device_id
        description: "Идентификатор устройства"
        tests:
          - not_null
          - dbt_utils.not_constant
          
      - name: location_id
        description: "Идентификатор локации"
        tests:
          - not_null
          - dbt_utils.not_constant
          
      - name: dq_score
        description: "Общий DQ score"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0.8
              max_value: 1.0

# Кастомные тесты для DQ проверок
tests:
  - name: energy_data_completeness
    description: "Проверка полноты критических полей энергетических данных"
    model: stg_energy_data
    config:
      severity: warn
    columns:
      - name: energy_consumption
        tests:
          - completeness:
              threshold: 0.95
              
  - name: energy_data_uniqueness
    description: "Проверка уникальности измерений"
    model: stg_energy_data
    config:
      severity: error
    columns:
      - name: id
        tests:
          - uniqueness:
              threshold: 0.99
              
  - name: energy_data_value_ranges
    description: "Проверка диапазонов значений энергетических параметров"
    model: stg_energy_data
    config:
      severity: warn
    columns:
      - name: energy_consumption
        tests:
          - value_range:
              min_value: 0
              max_value: 10000
      - name: voltage
        tests:
          - value_range:
              min_value: 200
              max_value: 250
      - name: current
        tests:
          - value_range:
              min_value: 0
              max_value: 100
      - name: power_factor
        tests:
          - value_range:
              min_value: 0.8
              max_value: 1.0
              
  - name: energy_data_date_format
    description: "Проверка формата дат"
    model: stg_energy_data
    config:
      severity: error
    columns:
      - name: timestamp
        tests:
          - date_format
          
  - name: energy_data_no_duplicates
    description: "Проверка отсутствия дубликатов по ключевым полям"
    model: stg_energy_data
    config:
      severity: error
    columns:
      - name: "id, timestamp, device_id"
        tests:
          - no_duplicates
          
  - name: energy_data_consistency
    description: "Проверка согласованности энергетических параметров"
    model: stg_energy_data
    config:
      severity: warn
    columns:
      - name: "energy_consumption, voltage, current, power_factor"
        tests:
          - data_consistency:
              business_rule: "energy_consumption = voltage * current * power_factor / 1000"
