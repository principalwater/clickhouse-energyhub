# clickhouse_energyhub

dbt проект для ClickHouse EnergyHub с интегрированными Data Quality (DQ) проверками.

## Описание

Этот проект предназначен для управления данными в ClickHouse кластере с автоматическими проверками качества данных. Проект включает в себя:

- **Модели данных**: staging, marts, intermediate слои
- **DQ проверки**: автоматические тесты качества данных
- **Макросы**: переиспользуемые компоненты для DQ проверок
- **Тесты**: кастомные тесты для валидации данных

## Структура проекта

```
clickhouse_energyhub/
├── models/                 # Модели данных
│   ├── staging/           # Сырые данные
│   ├── marts/             # Готовые для анализа данные
│   └── intermediate/      # Промежуточные преобразования
├── macros/                # Макросы для DQ проверок
├── tests/                 # Кастомные тесты
├── seeds/                 # Справочные данные
├── snapshots/             # Снапшоты для отслеживания изменений
├── analysis/              # Аналитические запросы
├── profiles/              # Конфигурация подключений
└── target/                # Артефакты сборки
```

## Подключение к ClickHouse

Проект настроен для работы с ClickHouse кластером `default`.

### Параметры подключения

- **Хост**: clickhouse-01
- **Порт**: 9000
- **База данных**: default
- **Пользователь**: bi_user

## Data Quality проверки

### Доступные макросы

1. **check_completeness** - проверка полноты данных
2. **check_uniqueness** - проверка уникальности
3. **check_value_range** - проверка диапазона значений
4. **check_date_format** - проверка формата дат
5. **check_referential_integrity** - проверка ссылочной целостности
6. **check_data_statistics** - статистика данных

### Примеры использования

```sql
-- Проверка полноты данных
{{ check_completeness('user_id', 'users', 0.95) }}

-- Проверка уникальности
{{ check_uniqueness('email', 'users', 0.99) }}

-- Проверка диапазона значений
{{ check_value_range('age', 'users', 0, 120) }}
```

### Кастомные тесты

Проект включает готовые тесты для DQ проверок:

- `completeness` - тест на полноту
- `uniqueness` - тест на уникальность
- `value_range` - тест на диапазон значений
- `date_format` - тест на формат даты
- `referential_integrity` - тест на ссылочную целостность
- `no_duplicates` - тест на отсутствие дубликатов
- `data_consistency` - тест на согласованность данных

## Запуск проекта

### Инициализация

```bash
# Установка зависимостей
dbt deps

# Проверка конфигурации
dbt debug
```

### Основные команды

```bash
# Запуск моделей
dbt run

# Запуск тестов
dbt test

# Генерация документации
dbt docs generate

# Запуск документации
dbt docs serve
```

### Запуск DQ проверок

```bash
# Запуск всех тестов
dbt test

# Запуск конкретного теста
dbt test --select test_type:completeness

# Запуск тестов для конкретной модели
dbt test --models staging.users
```

## Мониторинг DQ

### Настройки мониторинга

- **Схема DQ**: dq_checks
- **Порог ошибок**: 10% (dev), 5% (prod), 20% (test)
- **Уведомления**: email на admin@energyhub.local

### Просмотр результатов

```sql
-- Результаты DQ проверок
SELECT * FROM dq_checks.dq_test_results 
WHERE test_date >= today() - 7
ORDER BY test_date DESC;
```

## Конфигурация

### Переменные проекта

- `dq_enabled`: включение/отключение DQ проверок
- `dq_schema`: схема для хранения результатов DQ
- `dq_failure_threshold`: допустимый процент ошибок
- `enable_dq_monitoring`: включение мониторинга

### Профили

- **dev**: разработка (4 потока, порог 10%)
- **prod**: продакшн (8 потоков, порог 5%)
- **test**: тестирование (2 потока, порог 20%)

## Разработка

### Добавление новых DQ проверок

1. Создайте макрос в `macros/dq_macros.yml`
2. Добавьте тест в `tests/`
3. Обновите документацию

### Лучшие практики

- Используйте существующие макросы для типовых проверок
- Настраивайте пороги в зависимости от окружения
- Документируйте бизнес-правила для DQ проверок
- Мониторьте производительность DQ тестов

## Поддержка

Для вопросов по DQ проверкам обращайтесь к команде Data Engineering.

---

**Версия**: 1.0.0  
**Последнее обновление**: 2025-08-12T00:04:16Z
