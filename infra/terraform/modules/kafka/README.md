# Terraform Module: Apache Kafka

Этот модуль Terraform разворачивает готовый к использованию брокер Apache Kafka с Zookeeper и базовыми настройками безопасности.

## Архитектура

Модуль создает следующие компоненты:
- **Zookeeper:** Один контейнер `confluentinc/cp-zookeeper`, необходимый для координации Kafka.
- **Kafka Broker:** Один контейнер `confluentinc/cp-kafka`, представляющий собой брокер сообщений.
- **Безопасность:** По умолчанию включается аутентификация `SASL/SCRAM`, создается пользователь-администратор.
- **Начальная настройка:** С помощью `local-exec` provisioner создаются необходимые топики с заданной политикой хранения данных (TTL).

Все компоненты запускаются в единой Docker-сети, имя которой передается в качестве переменной, что обеспечивает легкую интеграцию с другими сервисами.

## Особенности

- **Безопасность по умолчанию:** Включена SASL/SCRAM аутентификация с созданием администратора.
- **Автоматическое создание топиков:** Модуль автоматически создает два топика (`energy_data_1min`, `energy_data_5min`) после запуска брокера.
- **Настраиваемый TTL:** Для создаваемых топиков по умолчанию устанавливается политика хранения сообщений в 1 день (`retention.ms=86400000`).
- **Генерация `.env` файла:** Модуль автоматически создает `kafka.env` файл в директории `infra/env` с учетными данными администратора для использования в Python-скриптах.

---

## Входные переменные (Input Variables)

| Имя | Описание |
| --- | --- |
| `kafka_version` | Версия для Docker-образов Confluent Platform. |
| `docker_network_name` | Имя Docker-сети для подключения контейнеров. |
| `topic_1min` | Название топика для 1-минутных данных. |
| `topic_5min` | Название топика для 5-минутных данных. |
| `kafka_admin_user` | Имя пользователя-администратора для Kafka. |
| `kafka_admin_password`| (Sensitive) Пароль для пользователя-администратора Kafka. |

---

## Доступ к сервисам

- **Zookeeper:** `localhost:2181`
- **Kafka Broker:** `localhost:9092`

Для подключения к брокеру из ваших приложений используйте адрес `localhost:9092` и учетные данные администратора, заданные в `terraform.tfvars`.

---

## Устранение неполадок (Troubleshooting)

- **Контейнер Kafka не запускается:**
  - Проверьте логи контейнера: `docker logs kafka`. Часто проблемы связаны с неправильной конфигурацией Zookeeper или нехваткой памяти.
  - Убедитесь, что Zookeeper запущен и доступен перед стартом Kafka. Модуль использует `depends_on` для обеспечения правильного порядка запуска.

- **Ошибка при создании топиков:**
  - Скрипт `create_kafka_topics` использует цикл ожидания, но на очень медленных машинах его может не хватить. Проверьте логи `terraform apply`.
  - Убедитесь, что `kafka-topics` в контейнере может подключиться к брокеру. Проблема может быть связана с сетевыми настройками или аутентификацией.
