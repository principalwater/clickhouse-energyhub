# Terraform Module: Monitoring (Portainer)

Этот модуль Terraform разворачивает Portainer Community Edition — легковесный и мощный инструмент для управления и мониторинга Docker-контейнеров в рамках проекта EnergyHub.

## Архитектура

Модуль создает следующие компоненты:
- **Portainer Container:** Один контейнер `portainer/portainer-ce`, который предоставляет веб-интерфейс для управления Docker.
- **Persistent Volume:** `docker_volume` с именем `portainer_data` для хранения данных и конфигурации Portainer, что обеспечивает их сохранность между перезапусками.
- **Docker Socket Access:** Модуль монтирует сокет Docker (`/var/run/docker.sock`) в контейнер, предоставляя Portainer полный доступ для управления другими контейнерами на хосте.
- **Dual Port Configuration:** Поддержка как HTTP (agent port), так и HTTPS (web UI) подключений.

## Особенности

- **Легковесный мониторинг:** Минимальное потребление ресурсов при максимальной функциональности
- **Веб-интерфейс:** Удобный графический интерфейс для управления всеми контейнерами проекта
- **Автоматический перезапуск:** Контейнер настроен с политикой `unless-stopped` для высокой доступности
- **Персистентное хранилище:** Все настройки и данные сохраняются между перезапусками
- **Безопасность:** Поддержка HTTPS для безопасного доступа к веб-интерфейсу

---

## Входные переменные (Input Variables)

| Имя | Описание | Тип | Обязательная |
| --- | --- | --- | --- |
| `portainer_version` | Версия Portainer CE (например, `latest` или `2.19.4`) | string | Да |
| `portainer_https_port` | Порт для доступа к веб-интерфейсу Portainer по HTTPS | number | Да |
| `portainer_agent_port` | Порт для HTTP-доступа и подключения Docker agent | number | Да |

---

## Доступ к сервису

После успешного выполнения `terraform apply`:

- **Portainer Web UI:**
  - **HTTPS URL:** `https://localhost:<portainer_https_port>` (по умолчанию `9443`)
  - **HTTP URL:** `http://localhost:<portainer_agent_port>` (по умолчанию `9000`)
  - **Первый вход:** При первом входе Portainer попросит вас создать пароль для пользователя `admin`

## Функциональность

Через Portainer вы можете:
- **Мониторить контейнеры:** Просматривать статус, логи, метрики всех контейнеров проекта (ClickHouse, Kafka, BI-инструменты)
- **Управлять контейнерами:** Запускать, останавливать, перезапускать контейнеры
- **Просматривать ресурсы:** Мониторить использование CPU, памяти, сети
- **Управлять образами:** Просматривать и удалять Docker-образы
- **Работать с сетями:** Управлять Docker-сетями проекта
- **Управлять томами:** Просматривать и управлять Docker-томами

---

## Интеграция с проектом

Portainer автоматически обнаружит и отобразит все контейнеры проекта EnergyHub:
- ClickHouse кластер (4 ноды + 3 Keeper)
- Kafka и Zookeeper
- BI-инструменты (Metabase, Superset, PostgreSQL)
- MinIO (если используется)

---

## Устранение неполадок (Troubleshooting)

- **Portainer не запускается:**
  - Проверьте, что Docker daemon запущен и доступен
  - Убедитесь, что порты не заняты другими приложениями: `netstat -tulpn | grep <port>`
  - Проверьте логи: `docker logs portainer`

- **Не удается подключиться к веб-интерфейсу:**
  - Убедитесь, что используете правильный протокол (HTTP/HTTPS) и порт
  - Проверьте настройки брандмауэра
  - Для HTTPS может потребоваться принять самоподписанный сертификат

- **Portainer не видит контейнеры:**
  - Убедитесь, что Docker socket правильно смонтирован
  - Проверьте права доступа к `/var/run/docker.sock`
